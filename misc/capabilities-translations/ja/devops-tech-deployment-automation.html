<html devsite><head><meta content="text/html; charset=UTF-8" http-equiv="Content-Type" />
    <title>DevOps 技術: デプロイの自動化</title>
    <meta name="book_path" value="/architecture/devops/_book.yaml"/>
    <meta name="project_path" value="/architecture/devops/_project.yaml"/>
    <meta name="translation_service" value="machine_translation_light_post_edit"/>
  </head>
  <body>

<aside class="note"><strong>注:</strong><span> デプロイの自動化は、ソフトウェア デリバリーと組織のパフォーマンスを改善する一連の仕組みの一つです。<em></em>これらの能力は <a href="https://www.devops-research.com/research.html">DORA State of DevOps Research Program</a> で発見されました。これは、高いパフォーマンスを生み出すプラクティスと機能に関する、学術的に厳格で独立した研究調査です。詳細については、<a href="/devops">DevOps のリソース</a>をご覧ください。</span></aside><p>デプロイの自動化とは、ボタンを押すだけでソフトウェアをテストや本番環境にデプロイできるようにすることです。本番環境のリスクを軽減するには、自動化が不可欠です。また、変更後にチームが包括的なテストをできるだけ早く行えるようにして、ソフトウェアの品質について迅速なフィードバックが得られるようにすることも同様に欠かせません。</p>

<p>自動デプロイのプロセスには次のようなインプットがあります。</p>

<ul>
<li>継続的インテグレーション（CI）プロセスによって作成されたパッケージ。パッケージは本番環境を含むあらゆる環境にデプロイできます。</li>
<li>環境の構成、パッケージのデプロイ、デプロイテスト（スモークテスト<em></em>）を行うスクリプト。</li>
<li>環境固有の構成情報</li>
</ul>

<p>スクリプトと構成情報は、バージョン管理システムに保存することをおすすめします。デプロイ プロセスでは、アーティファクト リポジトリ（<a href="/artifact-registry" track-type="article" track-name="internalLink" track-metadata-position="body">Artifact Registry</a>、<a href="https://www.sonatype.com/nexus-repository-sonatype" target="external" track-type="article" track-name="externalLink" track-metadata-position="body" class="external">Nexus</a>、<a href="https://jfrog.com/artifactory/" target="external" track-type="article" track-name="externalLink" track-metadata-position="body" class="external">Artifactory</a>、CI ツールの組み込みリポジトリなど）からパッケージがダウンロードされます。</p>

<p>通常、スクリプトは、次のタスクを実行します。</p>

<ol>
<li>ターゲット環境を準備します。これは、必要なソフトウェアのインストールと構成を行うか、Google Cloud などのクラウド プロバイダにあらかじめ準備されているイメージから、仮想ホストを起動することによって行います。</li>
<li>パッケージをデプロイします。</li>
<li>データベースの移行スクリプトを実行するなど、デプロイに関連するタスクを実行します。</li>
<li>必要な構成を行います。</li>
<li>デプロイテストを行い、必要な外部のサービスにアクセスでき、システムが機能していることを確認します。</li>
</ol>

<h2 id="how_to_implement_deployment_automation" data-text="デプロイ自動化の実装方法">デプロイ自動化の実装方法</h2>

<p>デプロイの自動化を設計する際は、次のベスト プラクティスを採用することをおすすめします。</p>

<ul>
<li><strong>本番環境を含めすべての環境に、同じデプロイ プロセスを使用します。</strong>この原則により、本番環境へのデプロイでそのプロセスを使用する前に、何回もデプロイ プロセスをテストできるようになります。</li>
<li><strong>必要な認証情報があれば、アーティファクトのバージョンにかかわらず、あらゆる環境にオンデマンドかつ完全に自動で、誰でもデプロイできるようにします。</strong>チケットを作成して、環境が準備されるのを待つ必要がある場合は、完全に自動化されたデプロイ プロセスとはいえません。</li>
<li><strong>すべての環境で同じパッケージを使用します。</strong>この原則は、パッケージとは別に、環境固有の構成を持つことを意味します。これにより、本番環境にデプロイするパッケージが、テストしたパッケージと同じものになります。</li>
<li><strong>バージョン コントロールに保存されている情報から環境の状態を再現できるようにします。</strong>この原則により、デプロイを繰り返し行えるようになり、障害復旧の際に本番環境が確実に復元できます。</li>
</ul>

<p>自律的に使用できるデプロイ用のツールを持ち、そのツールを使用して、各環境における現行のビルドや、監査用にデプロイ プロセスの出力を記録するのが理想です。CI ツールの多くが、このような機能を備えています。</p>

<h2 id="common_pitfalls_in_deployment_automation" data-text="デプロイの自動化における主な注意点">デプロイの自動化における主な注意点</h2>

<p>デプロイ プロセスを自動化する際に発生する問題は、次のとおりです。</p>

<ul>
<li>既存のプロセスが複雑。</li>
<li>サービス間の依存。</li>
<li>自動化を意識して設計されていないコンポーネント。</li>
<li>チーム間の協調が不十分。</li>
</ul>

<h3 id="complexity" data-text="複雑さ">複雑さ</h3>

<p>最初の注意点は、複雑性です。複雑で破綻しやすい手動のプロセスを自動化することにより、複雑で破綻しやすい自動化されたプロセスが作り出されます。まず、デプロイが容易になるように再設計する必要があります。これはデプロイ スクリプトを可能な限りシンプルに作り、複雑な部分は、アプリケーション コードやインフラストラクチャ プラットフォームで実現することを意味します。デプロイの失敗のパターンに目を配り、サービス、コンポーネント、インフラストラクチャ プラットフォーム、モニタリングをどのように改善するとその失敗を回避することができたかを考えます。<a href="/appengine" track-type="article" track-name="internalLink" track-metadata-position="body">App Engine</a>、<a href="/run" track-type="article" track-name="internalLink" track-metadata-position="body">Cloud Run</a>、<a href="/architecture/cloud-foundry-on-gcp" track-type="article" track-name="internalLink" track-metadata-position="body">Pivotal Cloud Foundry</a> など、クラウド ネイティブの PaaS（Platform-as-a-Service）アプリケーションでは、1 つのコマンドでデプロイできることが多く、他にデプロイ用のスクリプトを必要としていません。デプロイのプロセスは、このような形にするのが理想です。</p>

<p>信頼性の高いデプロイ プロセスには、重要な特性が 2 つあります。まず、デプロイ プロセスの各ステップは、失敗したとき、必要に応じて何度繰り返しても同じ結果が得られるようにします（べき等性）。次に、各ステップは実行順序に依存しないようにします。これは、必要としている他のコンポーネントやサービスが存在しない場合に想定外のクラッシュが起きないようにすることを意味します。代わりに、依存するサービスが利用可能になるまで、縮退した形で動作するようにします。</p>

<p>新しいプロダクトやサービスに対しては、設計の初期段階からこれらの原則を、システム要件として取り扱うことをおすすめします。既存のシステムに自動化を組み込む場合は、これらの特性を実装するか、プロセスが不整合な状態を検出して安全に失敗するようなテレメトリーを組み込む必要があるかもしれません。</p>

<h3 id="dependencies" data-text="依存関係">依存関係</h3>

<p>2 番目の注意点は、多くのデプロイ プロセスが、オーケストレーションを必要としていることです。これは特に企業環境において顕著です。つまり、緊密に同期したデータベースの移行など、他のタスクを実行しながら、複数のサービスを一度に、決まった順序でデプロイする必要があります。このような状況に対応する、多くの企業向けデプロイ ワークフロー ツールがありますが、それらは基本的に構造的な問題に応急処置的な対処（さまざまなコンポーネントやサービスを緊密に結合させる）をするものです。時間が経つと、この緊密な結合に対処する必要が出てきます。目標は、オーケストレーションの必要をなくし、サービスを独立してデプロイできるようにすることです。</p>

<p>この方法には通常、それぞれのサービスが下位互換性を持つようにする慎重な設計が必要です。これにより、サービスのクライアントを決まった手順で更新する必要がなくなり、後で独立に更新できるようになります。これには、<a href="/architecture/migrating-a-monolithic-app-to-microservices-gke#api_contracts" track-type="article" track-name="internalLink" track-metadata-position="body">API バージョニング</a>などの手法を利用できます。また、依存するほかのサービスに接続できない場合でも、サービスが動作を続ける（おそらく機能のいくつかは利用できない）ようにすることも重要です。このような設計は、障害の連鎖を防止するため、分散システムに向いています。Michael Nygard 氏の著書『Release It! 本番用ソフトウェア製品の設計とデプロイのために』には、<a href="https://martinfowler.com/bliki/CircuitBreaker.html" target="external" track-type="article" track-name="externalLink" track-metadata-position="body" class="external">CircuitBreaker</a>（回路ブレーカー）など、分散システムの設計に役立ついくつかのパターンが紹介されています。また、<a href="https://martinfowler.com/bliki/ParallelChange.html" target="external" track-type="article" track-name="externalLink" track-metadata-position="body" class="external">ParallelChange パターン</a>を使用して、データベースの更新を依存するサービスから切り離すこともできます。</p>

<h3 id="not_designed_for_automation" data-text="自動化向きでない設計">自動化向きでない設計</h3>

<p>3 番目の注意点は、自動化向けに設計されていないコンポーネントです。コンソールへのロギングと、手動操作であちこちをクリックする必要があるデプロイ プロセスは、改善の対象になります。現在、Google Cloud などのほとんどのプラットフォームでは、ユーザーのデプロイ スクリプトから利用できる API を提供しています。それがない場合は、独自の方法でこのような手作業を避ける必要があります。おそらく、ツールの裏にある構成ファイルやデータベースを見つけて、直接それを変更するか、API のある他のツールで置き換える必要があります。</p>

<h3 id="poor_collaboration_between_teams" data-text="チーム間の協調が不十分">チーム間の協調が不十分</h3>

<p>最後の注意点は、デベロッパーと IT 運用チームの調和がとれていないときに起こります。これには、いくつかの原因が考えられます。たとえば、デベロッパーがある手法でデプロイし、IT 運用担当者は異なる手法を使うような場合です。また別の例を挙げると、複数の環境の構成が異なる場合、それが不整合とエラーの原因となり、IT 運用担当者が行う手動のデプロイ プロセスのリスクがかなり引き上げられます。デプロイの自動化プロセスは、デベロッパーと IT 運用担当者の共同作業で作られる必要があります。これにより、どちらのチームもデプロイの自動化を理解、維持し、進化させることができるようになります。</p>

<h2 id="ways_to_improve_deployment_automation" data-text="デプロイ自動化の改善方法">デプロイ自動化の改善方法</h2>

<p>最初のステップは、デベロッパーと運用担当者のどちらからも共通に使用できる Google ドキュメントや wiki などのツールで、既存のデプロイ プロセスをドキュメント化することです。続いて、段階的に簡略化を進めながら、デプロイ プロセスを自動化します。この方法は通常、次のタスクで構成されます。</p>

<ul>
<li>デプロイに適した方法でコードをパッケージ化する。</li>
<li>事前構成された仮想マシンまたはコンテナを作成する。</li>
<li>ミドルウェアのデプロイと構成を自動化する。</li>
<li>本番環境にパッケージやファイルをコピーする。</li>
<li>サーバー、アプリケーション、またはサービスを再起動する。</li>
<li>テンプレートから構成ファイルを生成する。</li>
<li>自動化されたデプロイテストを実行して、システムが動作することと正常に構成されることを確認する。</li>
<li>テスト手順を実行する。</li>
<li>データベース移行のスクリプトを作成し、自動化する。</li>
</ul>

<p>できる限り手動の手順をなくし、必要に応じてべき等性と命令の独立性を実装して、インフラストラクチャプラットフォームの機能を最大限に活用します。デプロイの自動化はできる限りシンプルにする必要があります。</p>

<h2 id="ways_to_measure_deployment_automation" data-text="デプロイ自動化の評価方法">デプロイ自動化の評価方法</h2>

<p>デプロイ自動化の評価は単純です。</p>

<ul>
<li><strong>デプロイ プロセスの手動ステップ数を数えます</strong>。このステップ数は、意識して少なくするように努めます。手動のステップ数が増えると、デプロイ時間とエラーの発生が増加します。</li>
<li><strong>デプロイ パイプラインの自動化のレベル（または割合）を評価します</strong>。このレベルは、継続的に増加させるように努めます。</li>
<li><strong>デプロイ パイプライン中の遅延時間を求めます</strong>。遅延時間の短縮が進むにつれて、デプロイ パイプライン中のコードが停止する場所と理由がわかります。</li>
</ul>

<h2 id="whats_next" data-text="次のステップ">次のステップ</h2>

<ul>
<li><a href="/devops" track-type="solution" track-name="internalLink" track-metadata-position="body">DevOps ページ</a>で他の記事やリソースへのリンクを確認する。</li>
<li>Google Cloud の<a href="/solutions/continuous-delivery" track-type="solution" track-name="internalLink" track-metadata-position="body">継続的デリバリー ソリューション</a>について確認する。</li>
<li><a href="https://landing.google.com/sre/books/" target="external" track-type="article" track-name="externalLink" track-metadata-position="body">書籍『SRE サイト リライアビリティ エンジニアリング』</a>の特に<a href="https://landing.google.com/sre/sre-book/chapters/release-engineering/" target="external" track-type="article" track-name="externalLink" track-metadata-position="body">「第 8 章 - リリース エンジニアリング」</a> を読む。</li>
<li><a href="http://www.informit.com/articles/article.aspx?p=1833567" target="external" track-type="article" track-name="externalLink" track-metadata-position="body" class="external">Four Principles of Low-Risk Software Releases</a> を読む。</li>
<li>DevOps <a href="https://www.devops-research.com/research.html">研究プログラム</a>を調べる。</li>
<li><a href="https://www.devops-research.com/quickcheck.html">DevOps のクイック チェック</a>を確認する。業界におけるご自身の立ち位置を把握できます。</li>
</ul>

</body></html>